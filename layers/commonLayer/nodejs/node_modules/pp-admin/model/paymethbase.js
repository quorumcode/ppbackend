const { Q } = require('pp-mysql/client').shorthands();

const { FIELD, Model } = require('./model');

/// User payment method base data
class PaymethBase extends Model {
    static PRIMARY = 'primary';
    static PRIMARY_SID = 'primary_sid';

    static table = 'user_paymeth';///< DB table

    /// API field => DB field
    static api2db = {
        [this.ID]: {// Integer ID of user payment method
            [FIELD.DBFIELD]: ['user', 'pmID'],
        },
        [this.SID]: {// ID of payment method at provider
            [FIELD.DBFIELD]: 'pmID',
            [FIELD.READONLY]: true,
        },
        'user_id': {// User owner of payment method
            [FIELD.DBFIELD]: 'user',
            [FIELD.READONLY]: true,
        },
        [this.PRIMARY]: {// Flag of primary (autogenerated by compare sid and primary_sid)
            [FIELD.MODE]: FIELD.MODE_CALC,
            [FIELD.REQ]: [ this.SID, this.PRIMARY_SID ],
            [FIELD.SELECT]: `IF(${Q('pmID')}=${Q(this.PRIMARY_SID)},TRUE,FALSE)`,
        },
        'added_dt': {// Datetime when added
            [FIELD.DBFIELD]: 'addedTimestampS',
        },
        'type': {},// Type of payment method: visa, mastercard, ...
        'digits': {},// Last 4 digits of card number,
        'expire_year': {},// Year of card expire
        'expire_month': {},// Month of card expire
        'expiration': {// Month/Year of card expiration
            [FIELD.MODE]: FIELD.MODE_CALC,
            [FIELD.REQ]: [ 'expire_year', 'expire_month' ],
            [FIELD.SELECT]: `IF(ISNULL(${Q('expire_year')}) OR ISNULL(${Q('expire_month')}), NULL, CONCAT(LPAD(${Q('expire_month')}, 2, '0'), '/', ${Q('expire_year')}))`,
        },
        'country_code': {},// Card country code ISO 3166-1 Alpha-2
        'funding': {},// Funding of card (credit/debit/prepaid/unknown)
        'support3dsecure': {},// Is card support 3D secure
        'name': {},// Cardholder name
        'fingerprint': {},// Uniquely identifies this particular card number
        [this.PRIMARY_SID]: {// ID of primary payment method at provider (readonly by JOIN)
            [FIELD.MODE]: FIELD.MODE_JOIN,
            [FIELD.SELECT]: `u.${Q(this.PRIMARY_SID)}`,
            [FIELD.JOIN]: 'joinUser',// function for make JOIN SQL
        },
    };
}

module.exports = { PaymethBase };
