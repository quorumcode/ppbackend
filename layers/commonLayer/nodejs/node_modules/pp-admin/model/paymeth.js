const { Q } = require('pp-mysql/client').shorthands();
const { isArray } = require('./model');
const { PaymethBase } = require('./paymethbase');
const { UserBase } = require('./userbase');

/// User payment method
class Paymeth extends PaymethBase {

    /// Get many rows by filter and with orders
    static async tbl(get, and = [], order = [], ofs = 0, len = this.MAXLEN) {
        if ((isArray(order)) && (!order.length)) order = [ [this.PRIMARY, 'DESC'], ['added_dt', 'DESC'] ];
        return super.tbl(get, and, order, ofs, len);
    };

    static joinUser() {
        const ands = [];
        if (UserBase.patchAnds) UserBase.patchAnds(ands);
        return `LEFT JOIN (` +
            `SELECT ${[
                `${UserBase.QSelect(UserBase.ID)} AS ${Q('join_user_id')}`,
                `${UserBase.QSelect('primary_paymeth_sid')} AS ${Q(this.PRIMARY_SID)}`,
            ].join(',')} ` +
            `FROM ${Q(UserBase.table)} ` +
            (ands.length ? ` WHERE (${ands.join(')AND(')})` : '') +
        `) AS u ` +
            `ON ${this.QSelect('user_id')}=u.${Q('join_user_id')}`;
    };
}

module.exports = { Paymeth };
