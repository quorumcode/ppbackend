const { Q } = require('pp-mysql/client').shorthands();
const { SEARCH, FIELD } = require('./model');
const { LoanJSONBase } = require('./loanjsonbase');
const { LoanItemBase } = require('./loanitembase');

/// Loan custom items base data
class LoanCItemBase extends LoanJSONBase {

    /// Return same manes of fields as Items
    static PRODUCT = { ...LoanItemBase.PRODUCT };

    static fieldCItem = {
        [FIELD.MODE]: FIELD.MODE_JOIN,
        [FIELD.REQ]: ['loan_id'],
        [FIELD.JOIN]: 'joinCItem',// function for make JOIN SQL
    };

    /// API field => DB field
    static api2db = {
        ...super.api2db,
        [this.JSONORD]: {
            ...super.api2db[this.JSONORD],
            ...this.fieldCItem,
        },
        [this.PRODUCT.SID]: {// Product String ID
            [FIELD.MODE]: FIELD.MODE_CALC,
            [FIELD.SELECT]: null,
        },
        [this.PRODUCT.NAME]: {// Name of merchant product (readonly by JOIN)
            ...this.fieldCItem,
            [FIELD.SELECT]: `${Q(this.jsontable)}.${Q(this.PRODUCT.NAME)}`,
        },
        [this.PRODUCT.QUANTITY]: {// Quantity of merchant product (readonly by JOIN)
            ...this.fieldCItem,
            [FIELD.SELECT]: `${Q(this.jsontable)}.${Q(this.PRODUCT.QUANTITY)}`,
        },
        [this.PRODUCT.IMAGE_URL]: {// Image url of merchant product (readonly by JOIN)
            ...this.fieldCItem,
            [FIELD.SELECT]: `${Q(this.jsontable)}.${Q(this.PRODUCT.IMAGE_URL)}`,
        },
        [this.PRODUCT.PRICE_TOTAL]: {// Total price of merchant product (readonly by JOIN)
            ...this.fieldCItem,
            [FIELD.SELECT]: `${Q(this.jsontable)}.${Q(this.PRODUCT.PRICE_TOTAL)}`,// pounds
        },
        [this.PRODUCT.PRICE_WOTAX]: {// Price without tax of merchant product
            [FIELD.MODE]: FIELD.MODE_CALC,
            [FIELD.SELECT]: null,
        },
        [this.PRODUCT.TAX_PERCENT]: {// Tax percent of merchant product
            [FIELD.MODE]: FIELD.MODE_CALC,
            [FIELD.SELECT]: null,
        },
    };

    /// Search parameters
    static search = {
        [this.PRODUCT.NAME]: {// Merchant product name
            [SEARCH.WEQ]: 200,// Weight of search word (EQ)ual field
            [SEARCH.WIEQ]: 100,// Weight of search word (I)ndepend case (EQ)ual field
            [SEARCH.WHAS]: 50,// Weight of field (HAS) search word inside
            [SEARCH.WIHAS]: 50,// Weight of field (I)ndepend case (HAS) search word inside
        },
    };

    /// Construct SQL for JSON table from field
    static jsonTable() {
        return `JSON_TABLE(${Q(this.table)}.${Q('customItems')}, '$[*]' COLUMNS(${[
            `${Q(this.JSONORD)} FOR ORDINALITY`,
            `${Q(this.PRODUCT.NAME)} VARCHAR(16) path '$.name'`,
            `${Q(this.PRODUCT.QUANTITY)} VARCHAR(16) path '$.qty'`,
            `${Q(this.PRODUCT.IMAGE_URL)} VARCHAR(16) path '$.imageLink'`,
            `${Q(this.PRODUCT.PRICE_TOTAL)} VARCHAR(16) path '$.price'`,
        ].join(',')}))`;
    }
}

module.exports = { LoanCItemBase };
