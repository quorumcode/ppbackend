const { Q } = require('pp-mysql/client').shorthands();
const { LoanItemBase } = require('./loanitembase');
const { ProductBase } = require('./productbase');

/// Loan item
class LoanItem extends LoanItemBase {
    static joinItem() {
        return `INNER JOIN ${this.jsonTable()} AS ${Q(this.jsontable)}`;
    };

    static cteProduct() {
        const ands = [];
        if (ProductBase.patchAnds) ProductBase.patchAnds(ands);
        return `${Q(this.PRODUCT.CTE)} AS (` +
            `SELECT ${[
                `${ProductBase.QSelect(ProductBase.SID)} AS ${Q(this.PRODUCT.SID)}`,
                `${ProductBase.QSelect('name')} AS ${Q(this.PRODUCT.NAME)}`,
                `${ProductBase.QSelect('image_url')} AS ${Q(this.PRODUCT.IMAGE_URL)}`,
                `${ProductBase.QSelect('price_total')} AS ${Q(this.PRODUCT.PRICE_TOTAL)}`,
                `${ProductBase.QSelect('price_wotax')} AS ${Q(this.PRODUCT.PRICE_WOTAX)}`,
                `${ProductBase.QSelect('tax_percent')} AS ${Q(this.PRODUCT.TAX_PERCENT)}`,
            ].join(',')} ` +
            `FROM ${Q(ProductBase.table)} ` +
            (ands.length ? ` WHERE (${ands.join(')AND(')})` : '') +
        `)`;
    };

    static joinProduct() {
        const ands = [];
        if (ProductBase.patchAnds) ProductBase.patchAnds(ands);
        return `LEFT JOIN ${Q(this.PRODUCT.CTE)} ` +
            `ON ${this.QSelect(this.PRODUCT.SID)}=${Q(this.PRODUCT.CTE)}.${Q(this.PRODUCT.SID)}`;
    };
}

module.exports = { LoanItem };
